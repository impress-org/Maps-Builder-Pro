var gmb_data;window.GMB_Directions=function(e,t,i,o){"use strict";var n,a,r,d,s,c={},l=[],g=new google.maps.DirectionsService;return c.cache=function(){c.$body=i("body")},c.init=function(){c.cache(),i(e).on("load",c.window_load)},c.window_load=function(){c.calc_routes(),c.$body.on("click, focus",".gmb-directions-autocomplete",c.gmb_setup_autocomplete),c.$body.on("cmb2_remove_row",".cmb-type-destination",function(e,t){c.calc_routes()}),c.$body.on("cmb2_add_row",".cmb-type-destination",function(e,t){var o=i(e.currentTarget).find(".empty-row .gmb-destination-fieldset"),n=i(e.currentTarget).find(".cmb-repeat-row").length;parseInt(i(o).data("iterator"));i(o).attr("data-iterator",n),i(o).data("iterator",n),i(e.currentTarget).find(".cmb-repeat-row:last .gmb-directions-autocomplete").focus()}),i("body").on("change",".gmb-travel-mode",function(e,t){c.calc_routes()})},c.gmb_setup_autocomplete=function(){var e=i(this),t=new google.maps.places.Autocomplete(e[0]);t.bindTo("bounds",map),google.maps.event.addDomListener(e[0],"keydown",function(e){13==e.keyCode&&e.preventDefault()}),google.maps.event.addListener(t,"place_changed",function(){var o=e.parents(".cmb-repeatable-grouping").find(".cmb-repeat-row").length;return n=t.getPlace(),a=i(e).parents(".gmb-destination-fieldset").find(".gmb-directions-latitude"),r=i(e).parents(".gmb-destination-fieldset").find(".gmb-directions-longitude"),d=i(e).parents(".gmb-destination-fieldset").find(".gmb-directions-place_id"),s=i(e).parents(".gmb-destination-fieldset").find(".gmb-directions-address"),a.val(n.geometry.location.lat()),r.val(n.geometry.location.lng()),d.val(n.place_id),s.val(n.formatted_address),n.geometry?(1==o&&e.parents(".cmb-type-destination").find(".cmb-add-row-button").trigger("click"),void c.calc_routes()):void alert("Error: Place not found!")})},c.calc_routes=function(){i("#gmb_directions_group_repeat").find(".cmb-repeatable-grouping").each(function(t,o){l[t]&&l[t].setMap(null),l[t]=new google.maps.DirectionsRenderer,l[t].setMap(e.map);var n,a=i(this).find(".cmb-repeat-row"),r=a.first().find(".gmb-directions-latitude").val(),d=a.first().find(".gmb-directions-longitude").val(),s=a.first().find(".gmb-directions-address").val();n=s?s:r+","+d;var c,m=a.last().find(".gmb-directions-latitude").val(),u=a.last().find(".gmb-directions-longitude").val(),p=a.last().find(".gmb-directions-address").val();c=p&&p!==s?p:m!==r&&u!==d?m+","+u:"";var b=i(this).find(".gmb-travel-mode").val(),f=[];a.not(":first").not(":last").each(function(e,t){var o,n=i(this).find(".gmb-directions-address").val(),a=i(this).find(".gmb-directions-latitude").val(),r=i(this).find(".gmb-directions-longitude").val();o=n?n:a+","+r,f.push({location:o,stopover:!0})});var v={origin:n,destination:c,waypoints:f,optimizeWaypoints:!0,travelMode:google.maps.TravelMode[b]};g.route(v,function(e,i){i==google.maps.DirectionsStatus.OK&&(l[t].setOptions({preserveViewport:!0}),l[t].setDirections(e))})})},i(t).ready(c.init),c}(window,document,jQuery);