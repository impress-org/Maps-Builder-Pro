/**
 *  Maps Directions
 *
 *  @description: Adds directions functionality to the maps builder
 *  @copyright: http://opensource.org/licenses/gpl-2.0.php GNU Public License
 *  @since: 2.0
 */
var gmb_data;!function(e){"use strict";/**
	 * Setup Directions Autocomplete Field
	 *
	 * @param element
	 * @returns {boolean}
	 */
function t(t){if("undefined"==typeof t[0])return!1;var s=new google.maps.places.Autocomplete(t[0]);s.bindTo("bounds",map),
//Tame the enter key to not save the post while using the dirs_autocomplete input
google.maps.event.addDomListener(t[0],"keydown",function(e){13==e.keyCode&&e.preventDefault()}),
//Autocomplete event listener
google.maps.event.addListener(s,"place_changed",function(){
//get place information
//Set appropriate field object vars
//set values
return n=s.getPlace(),o=e(t).parents(".gmb-destination-fieldset").find(".gmb-directions-latitude"),a=e(t).parents(".gmb-destination-fieldset").find(".gmb-directions-longitude"),d=e(t).parents(".gmb-destination-fieldset").find(".gmb-directions-place_id"),r=e(t).parents(".gmb-destination-fieldset").find(".gmb-directions-address"),o.val(n.geometry.location.lat()),a.val(n.geometry.location.lng()),d.val(n.place_id),r.val(n.formatted_address),n.geometry?void i():void alert("Error: Place not found!")})}/**
	 * Calculate Route
	 */
function i(){
//Loop through Directions group
e("#gmb_directions_group_repeat").find(".cmb-repeatable-grouping").each(function(t,i){s[t]&&s[t].setMap(null),
//Setup
s[t]=new google.maps.DirectionsRenderer,s[t].setMap(window.map);var n,o=e(this).find(".cmb-repeat-row"),a=o.first().find('.gmb-directions-latitude[data-iterator="0"]').val(),d=o.first().find('.gmb-directions-longitude[data-iterator="0"]').val(),r=o.first().find('.gmb-directions-address[data-iterator="0"]').val();n=r?r:a+","+d;
//Get Destination
var c,g=o.last().find(".gmb-directions-latitude").val(),m=o.last().find(".gmb-directions-longitude").val(),f=o.last().find(".gmb-directions-address").val();c=r?f:g+","+m;var p=e(this).find(".gmb-travel-mode").val(),u=[];
//Next Loop through interior destionations (not first or last) to get waypoints
o.not(":first").not(":last").each(function(t,i){var n,o=e(this).find(".gmb-directions-address").val(),a=e(this).find(".gmb-directions-latitude").val(),d=e(this).find(".gmb-directions-longitude").val();n=o?o:a+","+d,u.push({location:n,stopover:!0})});
//Directions Request
var v={origin:n,destination:c,waypoints:u,optimizeWaypoints:!0,travelMode:google.maps.TravelMode[p]};l.route(v,function(e,i){i==google.maps.DirectionsStatus.OK&&(s[t].setOptions({preserveViewport:!0}),//ensure users set lat/lng doesn't get all messed u
s[t].setDirections(e))})})}var n,o,a,d,r,s=[],l=new google.maps.DirectionsService;/**
	 * Kick it off on Window Load
	 */
e(window).on("load",function(){
//Calculate the route here
i(),
//Setup autocomplete for each input
e(".gmb-directions-autocomplete").each(function(i,n){t(e(this))}),
//Destination added
e("#gmb_directions_group_repeat").on("cmb2_add_row",function(i,n){t(e(n).find(".gmb-directions-autocomplete"))}),
//Destination row removed
e(".cmb-type-destination").on("cmb2_remove_row",function(e,t){i()}),
//Destination row removed
e("body").on("change",".gmb-travel-mode",function(e,t){i()})})}(jQuery);