/**
 *  Maps Directions
 *
 *  @description: Adds directions functionality to the maps builder
 *  @copyright: http://opensource.org/licenses/gpl-2.0.php GNU Public License
 *  @since: 2.0
 */
var gmb_data;!function(e){"use strict";/**
	 * Setup Directions Autocomplete Field
	 *
	 * @param element
	 * @returns {boolean}
	 */
function t(t){if("undefined"==typeof t[0])return!1;var d=new google.maps.places.Autocomplete(t[0]);d.bindTo("bounds",map),
//Tame the enter key to not save the post while using the dirs_autocomplete input
google.maps.event.addDomListener(t[0],"keydown",function(e){13==e.keyCode&&e.preventDefault()}),
//Autocomplete event listener
google.maps.event.addListener(d,"place_changed",function(){
//get place information
//Set appropriate field vars
//set lat lng input values
return o=d.getPlace(),n=e(t).parents(".gmb-destination-fieldset").find(".gmb-directions-latitude"),a=e(t).parents(".gmb-destination-fieldset").find(".gmb-directions-longitude"),r=e(t).parents(".gmb-destination-fieldset").find(".gmb-directions-place_id"),n.val(o.geometry.location.lat()),a.val(o.geometry.location.lng()),r.val(o.place_id),o.geometry?void i():void alert("Error: Place not found!")})}/**
	 * Calculate Route
	 */
function i(){
//Loop through Directions group
e("#gmb_directions_group_repeat").find(".cmb-repeatable-grouping").each(function(t,i){d[t]&&d[t].setMap(null);var o=new google.maps.DirectionsService;d[t]=new google.maps.DirectionsRenderer,d[t].setMap(window.map);
//Next loop through the groups within
var n=e(this).find(".cmb-repeat-row"),a=n.first().find('.gmb-directions-latitude[data-iterator="0"]').val(),r=n.first().find('.gmb-directions-longitude[data-iterator="0"]').val(),s=n.last().find(".gmb-directions-latitude").val(),l=n.last().find(".gmb-directions-longitude").val(),c=e(this).find(".gmb-travel-mode").val();console.log(c);var g=[];n.not(":first").not(":last").each(function(t,i){var o=e(this).find(".gmb-directions-latitude").val(),n=e(this).find(".gmb-directions-longitude").val();g.push({location:o+","+n,stopover:!0})});var m={origin:a+","+r,destination:s+","+l,waypoints:g,optimizeWaypoints:!0,travelMode:google.maps.TravelMode[c]};o.route(m,function(e,i){if(i==google.maps.DirectionsStatus.OK){d[t].setOptions({preserveViewport:!0}),d[t].setDirections(e);{e.routes[0]}}})})}var o,n,a,r,d=[];/**
	 * Kick it off on Window Load
	 */
e(window).on("load",function(){
//Calculate the route here
i(),
//Setup autocomplete for each input
e(".gmb-directions-autocomplete").each(function(i,o){t(e(this))}),
//Destination added
e("#gmb_directions_group_repeat").on("cmb2_add_row",function(i,o){t(e(o).find(".gmb-directions-autocomplete"))}),
//Destination row removed
e(".cmb-type-destination").on("cmb2_remove_row",function(e,t){i()}),
//Destination row removed
e("body").on("change",".gmb-travel-mode",function(e,t){i()})})}(jQuery);